Fixes CVE-2023-50447.
Desc:
  Pillow through 10.1.0 allows PIL.ImageMath.eval Arbitrary Code Execution via
  the environment parameter.

Upstream PR:
https://github.com/python-pillow/Pillow/pull/7655

--- Pillow-10.1.0/src/PIL/ImageMath.py
+++ Pillow-10.1.0/src/PIL/ImageMath.py
@@ -237,6 +237,11 @@ def eval(expression, _dict={}, **kw):
 
     # build execution namespace
     args = ops.copy()
+    for k in list(_dict.keys()) + list(kw.keys()):
+        if "__" in k or hasattr(builtins, k):
+            msg = f"'{k}' not allowed"
+            raise ValueError(msg)
+
     args.update(_dict)
     args.update(kw)
     for k, v in list(args.items()):
--- Pillow-10.1.0/Tests/test_imagemath.py
+++ Pillow-10.1.0/Tests/test_imagemath.py
@@ -63,6 +63,16 @@ def test_prevent_exec(expression):
         ImageMath.eval(expression)
 
 
+def test_prevent_double_underscores():
+    with pytest.raises(ValueError):
+        ImageMath.eval("1", {"__": None})
+
+
+def test_prevent_builtins():
+    with pytest.raises(ValueError):
+        ImageMath.eval("(lambda: exec('exit()'))()", {"exec": None})
+
+
 def test_logical():
     assert pixel(ImageMath.eval("not A", images)) == 0
     assert pixel(ImageMath.eval("A and B", images)) == "L 2"
