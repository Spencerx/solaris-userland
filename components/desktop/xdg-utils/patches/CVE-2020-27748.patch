Upstream commits from merge request 
https://gitlab.freedesktop.org/xdg/xdg-utils/-/merge_requests/89
are taken to fix CVE-2020-27748.

From 5f3f563d69ae72bbefe9031c68d8167935abcba5 Mon Sep 17 00:00:00 2001
From: Slatian <baschdel@disroot.org>
Date: Sat, 14 Oct 2023 13:14:44 +0200
Subject: [PATCH] Fix CVE-2020-27748 by paasing attachments seperately

---
 scripts/xdg-email.in | 42 ++++++++++++++++++++++++++++--------------
 1 file changed, 28 insertions(+), 14 deletions(-)

diff --git a/scripts/xdg-email.in b/scripts/xdg-email.in
index 4e3a5e8..6d83b0a 100644
--- a/scripts/xdg-email.in
+++ b/scripts/xdg-email.in
@@ -30,11 +30,14 @@ _USAGE
 
 #@xdg-utils-common@
 
+# (thunderbird_binary, mailto_uri, attached_files)
 run_thunderbird()
 {
     local THUNDERBIRD MAILTO NEWMAILTO TO CC BCC SUBJECT BODY ATTACH
     THUNDERBIRD="$1"
     MAILTO="$(echo "$2" | sed 's/^mailto://')"
+    ATTACH="$3"
+    
     echo "$MAILTO" | grep -qs "^?"
     if [ "$?" = "0" ] ; then
         MAILTO="$(echo "$MAILTO" | sed 's/^?//')"
@@ -48,7 +51,6 @@ run_thunderbird()
     BCC="$(/bin/echo -e "$(echo "$MAILTO" | grep '^bcc=' | sed 's/^bcc=//;s/%\(..\)/\\x\1/g' | awk '{ printf "%s,",$0 }')")"
     SUBJECT="$(echo "$MAILTO" | grep '^subject=' | tail -n 1)"
     BODY="$(echo "$MAILTO" | grep '^body=' | tail -n 1)"
-    ATTACH="$(/bin/echo -e "$(echo "$MAILTO" | grep '^attach=' | sed 's/^attach=//;s/%\(..\)/\\x\1/g' | awk '{ printf "%s,",$0 }' | sed 's/,$//')")"
 
     if [ -z "$TO" ] ; then
         NEWMAILTO=
@@ -82,6 +84,7 @@ run_thunderbird()
     fi
 }
 
+# (mailto, attach)
 open_kde()
 {
     local kreadconfig profile client
@@ -104,7 +107,7 @@ open_kde()
             fi
 
             if echo "$client" | grep -Eq 'thunderbird|icedove'; then
-                run_thunderbird "$client" "$1"
+                run_thunderbird "$client" "$1" "$2"
             fi
         fi
     fi
@@ -137,6 +140,7 @@ open_kde()
     fi
 }
 
+# (mailto, attach)
 open_gnome3()
 {
     local client
@@ -144,7 +148,7 @@ open_gnome3()
     desktop="$(xdg-mime query default "x-scheme-handler/mailto")"
     client="$(desktop_file_to_binary "$desktop")"
     case "$client" in *thunderbird*|*icedove*)
-        run_thunderbird "$client" "$1"
+        run_thunderbird "$client" "$1" "$2"
     esac
 
     if gio help open 2>/dev/null 1>&2; then
@@ -165,12 +169,13 @@ open_gnome3()
     fi
 }
 
+# (mailto, attach)
 open_gnome()
 {
     local client
     client="$(gconftool-2 --get /desktop/gnome/url-handlers/mailto/command | cut -d ' ' -f 1)"
     case "$client" in *thunderbird*|*icedove*)
-        run_thunderbird "$client" "$1"
+        run_thunderbird "$client" "$1" "$2"
     esac
 
     if gio help open 2>/dev/null 1>&2; then
@@ -191,7 +196,7 @@ open_gnome()
     fi
 }
 
-
+# (mailto, attach)
 open_lxqt()
 {
     local client
@@ -200,7 +205,7 @@ open_lxqt()
     client="$(desktop_file_to_binary "$desktop")"
     echo "$client" | grep -E 'thunderbird|icedove' > /dev/null 2>&1
     if [ $? -eq 0 ] ; then
-        run_thunderbird "$client" "$1"
+        run_thunderbird "$client" "$1" "$2"
     fi
 
     if qtxdg-mat open --help 2>/dev/null 1>&2; then
@@ -261,6 +266,7 @@ open_flatpak()
     fi
 }
 
+# (mailto, attach)
 open_generic()
 {
     local client
@@ -268,7 +274,7 @@ open_generic()
     desktop="$(xdg-mime query default "x-scheme-handler/mailto")"
     client="$(desktop_file_to_binary "$desktop")"
     case "$client" in *thunderbird*|*icedove*)
-        run_thunderbird "$client" "$1"
+        run_thunderbird "$client" "$1" "$2"
     esac
 
     xdg-open "$1"
@@ -317,6 +323,8 @@ LC_ALL="$ORIG_LC_ALL"
 
 options=
 mailto=
+# attach is a comma seperated list of url encoded filenames
+attach=
 utf8="iconv -t utf8"
 while [ $# -gt 0 ] ; do
     parm="$1"
@@ -383,7 +391,7 @@ while [ $# -gt 0 ] ; do
         fi
 
         url_encode "$file"
-        options="${options}attach=${result}&"
+        attach="${attach}${attach:+,}${result}"
         shift
         ;;
 
@@ -436,7 +444,7 @@ mailto="$(echo "${mailto}"| sed 's/[?&]$//')"
 [ x"${mailto}" != x"" ] || exit_failure_syntax
 
 if command -v @NAME@-hook.sh > /dev/null; then
-    @NAME@-hook.sh "${mailto}"
+    @NAME@-hook.sh "${mailto}" "$attach"
     if [ $? -eq 0 ]; then
         exit_success
     else
@@ -456,35 +464,41 @@ fi
 
 case "$DE" in
     envvar)
+	[ -z "$attach" ] || \
+		exit_failure_operation_impossible "Unable to use --attach with the MAILER envoirnment variable"
     open_envvar "${mailto}"
     ;;
 
     kde)
-    open_kde "${mailto}"
+    open_kde "${mailto}" "$attach"
     ;;
 
     gnome)
-    open_gnome "${mailto}"
+    open_gnome "${mailto}" "$attach"
     ;;
 
     gnome3|cinnamon|lxde|mate|deepin)
-    open_gnome3 "${mailto}"
+    open_gnome3 "${mailto}" "$attach"
     ;;
 
     lxqt)
-    open_lxqt "${mailto}"
+    open_lxqt "${mailto}" "$attach"
     ;;
 
     xfce)
+	[ -z "$attach" ] || \
+		exit_failure_operation_impossible "Unable to use --attach with the Xfce opener"
     open_xfce "${mailto}"
     ;;
 
     flatpak)
+	[ -z "$attach" ] || \
+		exit_failure_operation_impossible "Unable to use --attach from inside a flatpak"
     open_flatpak "${mailto}"
     ;;
 
     generic|enlightenment)
-    open_generic "${mailto}"
+    open_generic "${mailto}" "$attach"
     ;;
 
     *)
-- 
GitLab

From be7c2ce232472ed9f090eb5aac62db5481eb2fbc Mon Sep 17 00:00:00 2001
From: Slatian <baschdel@disroot.org>
Date: Sat, 14 Oct 2023 14:14:56 +0200
Subject: [PATCH] Give the hookscript an option so that possible future changes
 can be communicated clearly

---
 scripts/xdg-email.in | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/scripts/xdg-email.in b/scripts/xdg-email.in
index 6d83b0a..7a45370 100644
--- a/scripts/xdg-email.in
+++ b/scripts/xdg-email.in
@@ -444,7 +444,11 @@ mailto="$(echo "${mailto}"| sed 's/[?&]$//')"
 [ x"${mailto}" != x"" ] || exit_failure_syntax
 
 if command -v @NAME@-hook.sh > /dev/null; then
-    @NAME@-hook.sh "${mailto}" "$attach"
+	if [ -z "$attach" ] ; then
+	    @NAME@-hook.sh "${mailto}"
+	else
+	    @NAME@-hook.sh "${mailto}" --attach-files "$attach"
+	fi
     if [ $? -eq 0 ]; then
         exit_success
     else
-- 
GitLab

From 592cf2fd21dbe0c3df84006e075fb593d35df930 Mon Sep 17 00:00:00 2001
From: Slatian <baschdel@disroot.org>
Date: Sat, 14 Oct 2023 14:23:52 +0200
Subject: [PATCH] Documented the new (and old) behaviour of xdg-email to avoid
 some footguns.

---
 scripts/desc/xdg-email.xml | 49 ++++++++++++++++++++++++++++++++++++--
 1 file changed, 47 insertions(+), 2 deletions(-)

diff --git a/scripts/desc/xdg-email.xml b/scripts/desc/xdg-email.xml
index ac94f1b..2ed5d99 100644
--- a/scripts/desc/xdg-email.xml
+++ b/scripts/desc/xdg-email.xml
@@ -2,7 +2,7 @@
 <?xml-stylesheet type="text/xsl"
    href="http://docbook.sourceforge.net/release/xsl/current/manpages/docbook.xsl"?>
 <!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN"
-    "http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd" [
+    "http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd" [
 ]>
 <refentry id="xdg-email">
   <refentryinfo>
@@ -75,6 +75,11 @@
       will have the opportunity to change any of this information before
       actually sending the e-mail.
     </para>
+    <para>
+      Do not use xdg-email as the default handler for <code>mailto:</code> links.
+      Its main purpose is to assemble <code>mailto:</code> links and hand them over
+      to a capable program (usually the defult handler for <code>mailto:</code> links.
+    </para>
     <para>
       xdg-email is for use inside a desktop session only.
       It is not recommended to use xdg-email as root.
@@ -147,6 +152,9 @@
 	    Some e-mail applications require the file to remain present
             after xdg-email returns.
 	  </simpara>
+	  <simpara>
+         The attach option currently is only implemented for Thunderbird and Icedove on Gnome, Cinnamon, Lxde, Mate, Deepin, KDE, Lxqt and generic desktops with thunderbird as the mailclient or through a custom <command>xdg-email-hook.sh</command>. It will not work with the <envar>MAILE</envar> environment variable.
+	  </simpara>
 	</listitem>
       </varlistentry>
       
@@ -185,7 +193,7 @@
     </para>
     <variablelist>
       <varlistentry>
-	<term>XDG_UTILS_DEBUG_LEVEL</term>
+	<term><envar>XDG_UTILS_DEBUG_LEVEL</envar></term>
 	<listitem>
 	  <simpara>
 	    Setting this environment variable to a non-zero numerical value
@@ -194,8 +202,45 @@
 	  </simpara>
 	</listitem>
       </varlistentry>
+      <varlistentry>
+	<term><envar>MAILER</envar></term>
+	<listitem>
+      <simpara>
+	      With this variable a custom command can be set as opener
+	      for <code>mailto:</code> links, when set it will be preferred
+	      over desktop specific behavior unless a <command>xdg-email-hook.sh</command> is present.
+      </simpara>
+	  <simpara>
+	      The set command will be run with the URI appended as the last argument.
+      </simpara>
+      <simpara>
+	      The <envar>MAILER</envar> is not standardized, keep the command as simple as possible.
+      </simpara>
+	</listitem>
+      </varlistentry>
     </variablelist>
   </refsect1>
+  <refsect1 id="hook">
+	<title>Hook Script</title>
+	<para>
+      If a <command>xdg-email-hook.sh</command> command is present, it will
+      be used as the opener.
+    </para>
+    <para>
+      It is called with the URL as it's first argument:
+      <command>xdg-email-hook.sh</command> <replaceable>mailto_URL</replaceable>
+    </para>
+    <para>
+      If an attachment is specified it will be called
+      with an additional <option>--attach-files</option> option
+      followed by a list of one or more URI-encoded, comma seperated filepaths.
+      (This is compatible with the <command>thunderbird</command> <option>-compose</option> option)
+    </para>
+    <para>
+      Like this: <command>xdg-email-hook.sh</command> <replaceable>mailto_URL</replaceable>
+      <option>--attach-files</option> <replaceable>file-list</replaceable>
+    </para>
+  </refsect1>
   <refsect1 id="exitcodes">
     <title>Exit Codes</title>
     <para>
-- 
GitLab

From 9043ac2e8fb729b51bcccf85af536c6d2fc166ae Mon Sep 17 00:00:00 2001
From: Slatian <baschdel@disroot.org>
Date: Fri, 9 Feb 2024 10:27:10 +0100
Subject: [PATCH] Fixed a typo in the xdg-email docs

---
 scripts/desc/xdg-email.xml | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/scripts/desc/xdg-email.xml b/scripts/desc/xdg-email.xml
index 2ed5d99..dd14cb0 100644
--- a/scripts/desc/xdg-email.xml
+++ b/scripts/desc/xdg-email.xml
@@ -153,7 +153,7 @@
             after xdg-email returns.
 	  </simpara>
 	  <simpara>
-         The attach option currently is only implemented for Thunderbird and Icedove on Gnome, Cinnamon, Lxde, Mate, Deepin, KDE, Lxqt and generic desktops with thunderbird as the mailclient or through a custom <command>xdg-email-hook.sh</command>. It will not work with the <envar>MAILE</envar> environment variable.
+         The attach option currently is only implemented for Thunderbird and Icedove on Gnome, Cinnamon, Lxde, Mate, Deepin, KDE, Lxqt and generic desktops with thunderbird as the mailclient or through a custom <command>xdg-email-hook.sh</command>. It will not work with the <envar>MAILER</envar> environment variable.
 	  </simpara>
 	</listitem>
       </varlistentry>
-- 
GitLab

