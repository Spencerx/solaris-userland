#
# This patch addresses OpenSSH CVE-2024-39894.
#
# Changes are taken from upstream:
#  https://github.com/openssh/openssh-portable/commit/146c420d29d055cc75c8606327a1cf8439fe3a08
#  
# Patch can be removed once OpenSSH is upgraded to 9.8p1 or later version.
#
--- old/clientloop.c	2024-07-16 09:06:19.753575743 +0200
+++ new/clientloop.c	2024-07-16 09:09:50.785238099 +0200
@@ -612,8 +612,9 @@ obfuscate_keystroke_timing(struct ssh *s
 		if (timespeccmp(&now, &chaff_until, >=)) {
 			/* Stop if there have been no keystrokes for a while */
 			stop_reason = "chaff time expired";
-		} else if (timespeccmp(&now, &next_interval, >=)) {
-			/* Otherwise if we were due to send, then send chaff */
+		} else if (timespeccmp(&now, &next_interval, >=) &&
+		    !ssh_packet_have_data_to_write(ssh)) {
+			/* If due to send but have no data, then send chaff */
 			if (send_chaff(ssh))
 				nchaff++;
 		}
