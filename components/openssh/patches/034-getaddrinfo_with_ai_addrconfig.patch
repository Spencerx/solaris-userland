#
# Use AI_ADDRCONFIG flag for getaddrinfo() hints where
# the address family is AF_UNSPEC. See description of AI_ADDRCONFIG
# in getaddrinfo(3C).
#
# We have contributed back this fix to the OpenSSH upstream community. For
# more information, see https://bugzilla.mindrot.org/show_bug.cgi?id=2483
# In the future, if this fix is accepted by the upstream in a later release, we
# will remove this patch when we upgrade to that release.
#
--- openssh-9.4p1/canohost.c
+++ openssh-9.4p1/canohost.c
@@ -105,6 +105,10 @@ */
 	memset(&hints, 0, sizeof(hints));
 	hints.ai_family = from.ss_family;
 	hints.ai_socktype = SOCK_STREAM;
+#ifdef AI_ADDRCONFIG
+	if (hints.ai_family == AF_UNSPEC)
+		hints.ai_flags = AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	if (getaddrinfo(name, NULL, &hints, &aitop) != 0) {
 		logit("reverse mapping checking getaddrinfo for %.700s "
 		    "[%s] failed.", name, ntop);
--- openssh-9.4p1/channels.c
+++ openssh-9.4p1/channels.c
@@ -3759,8 +3759,12 @@ * set to NULL and hints.ai_flags is not
 	 */
 	memset(&hints, 0, sizeof(hints));
 	hints.ai_family = ssh->chanctxt->IPv4or6;
-	hints.ai_flags = wildcard ? AI_PASSIVE : 0;
 	hints.ai_socktype = SOCK_STREAM;
+	hints.ai_flags = wildcard ? AI_PASSIVE : 0;
+#ifdef AI_ADDRCONFIG
+	if (hints.ai_family == AF_UNSPEC)
+		hints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	snprintf(strport, sizeof strport, "%d", fwd->listen_port);
 	if ((r = getaddrinfo(addr, strport, &hints, &aitop)) != 0) {
 		if (addr == NULL) {
@@ -4634,6 +4638,10 @@ } else {
 		memset(&hints, 0, sizeof(hints));
 		hints.ai_family = ssh->chanctxt->IPv4or6;
 		hints.ai_socktype = socktype;
+#ifdef AI_ADDRCONFIG
+		if (hints.ai_family == AF_UNSPEC)
+			hints.ai_flags = AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 		snprintf(strport, sizeof strport, "%d", port);
 		if ((gaierr = getaddrinfo(name, strport, &hints, &cctx->aitop))
 		    != 0) {
@@ -4957,8 +4965,12 @@ display_number++) {
 		port = 6000 + display_number;
 		memset(&hints, 0, sizeof(hints));
 		hints.ai_family = ssh->chanctxt->IPv4or6;
-		hints.ai_flags = x11_use_localhost ? 0: AI_PASSIVE;
 		hints.ai_socktype = SOCK_STREAM;
+		hints.ai_flags = x11_use_localhost ? 0: AI_PASSIVE;
+#ifdef AI_ADDRCONFIG
+		if (hints.ai_family == AF_UNSPEC)
+			hints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 		snprintf(strport, sizeof strport, "%d", port);
 		if ((gaierr = getaddrinfo(NULL, strport,
 		    &hints, &aitop)) != 0) {
@@ -5180,6 +5192,10 @@ /* Look up the host address */
 	memset(&hints, 0, sizeof(hints));
 	hints.ai_family = ssh->chanctxt->IPv4or6;
 	hints.ai_socktype = SOCK_STREAM;
+#ifdef AI_ADDRCONFIG
+	if (hints.ai_family == AF_UNSPEC)
+		hints.ai_flags = AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	snprintf(strport, sizeof strport, "%u", 6000 + display_number);
 	if ((gaierr = getaddrinfo(buf, strport, &hints, &aitop)) != 0) {
 		error("%.100s: unknown host. (%s)", buf,
--- openssh-9.4p1/regress/netcat.c
+++ openssh-9.4p1/regress/netcat.c
@@ -343,6 +343,10 @@ hints.ai_socktype = uflag ? SOCK_DGRAM :
 		hints.ai_protocol = uflag ? IPPROTO_UDP : IPPROTO_TCP;
 		if (nflag)
 			hints.ai_flags |= AI_NUMERICHOST;
+#ifdef AI_ADDRCONFIG
+		if (hints.ai_family == AF_UNSPEC)
+			hints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	}
 
 	if (xflag) {
@@ -371,6 +375,10 @@ proxyhints.ai_socktype = SOCK_STREAM;
 		proxyhints.ai_protocol = IPPROTO_TCP;
 		if (nflag)
 			proxyhints.ai_flags |= AI_NUMERICHOST;
+#ifdef AI_ADDRCONFIG
+		if (proxyhints.ai_family == AF_UNSPEC)
+			proxyhints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	}
 
 	if (lflag) {
@@ -645,6 +653,10 @@ ahints.ai_family = res0->ai_family;
 			ahints.ai_socktype = uflag ? SOCK_DGRAM : SOCK_STREAM;
 			ahints.ai_protocol = uflag ? IPPROTO_UDP : IPPROTO_TCP;
 			ahints.ai_flags = AI_PASSIVE;
+#ifdef AI_ADDRCONFIG
+			if (ahints.ai_family == AF_UNSPEC)
+				ahints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 			if ((error = getaddrinfo(sflag, pflag, &ahints, &ares)))
 				errx(1, "getaddrinfo: %s", gai_strerror(error));
 
@@ -1412,8 +1424,12 @@ struct addrinfo hints, *res;
 
 	bzero(&hints, sizeof(hints));
 	hints.ai_family = v4only ? PF_INET : PF_UNSPEC;
-	hints.ai_flags = numeric ? AI_NUMERICHOST : 0;
 	hints.ai_socktype = SOCK_STREAM;
+	hints.ai_flags = numeric ? AI_NUMERICHOST : 0;
+#ifdef AI_ADDRCONFIG
+	if (hints.ai_family == AF_UNSPEC)
+		hints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	r = getaddrinfo(h, p, &hints, &res);
 	/* Don't fatal when attempting to convert a numeric address */
 	if (r != 0) {
--- openssh-9.4p1/servconf.c
+++ openssh-9.4p1/servconf.c
@@ -897,6 +897,10 @@ memset(&hints, 0, sizeof(hints));
 	hints.ai_family = options->address_family;
 	hints.ai_socktype = SOCK_STREAM;
 	hints.ai_flags = (addr == NULL) ? AI_PASSIVE : 0;
+#ifdef AI_ADDRCONFIG
+	if (hints.ai_family == AF_UNSPEC)
+		hints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	snprintf(strport, sizeof strport, "%d", port);
 	if ((gaierr = getaddrinfo(addr, strport, &hints, &aitop)) != 0)
 		fatal("bad addr or host: %s (%s)",
--- openssh-9.4p1/ssh-keyscan.c
+++ openssh-9.4p1/ssh-keyscan.c
@@ -371,6 +371,10 @@ snprintf(strport, sizeof strport, "%d",
 	memset(&hints, 0, sizeof(hints));
 	hints.ai_family = IPv4or6;
 	hints.ai_socktype = SOCK_STREAM;
+#ifdef AI_ADDRCONFIG
+	if (hints.ai_family == AF_UNSPEC)
+		hints.ai_flags = AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	if ((gaierr = getaddrinfo(host, strport, &hints, &aitop)) != 0) {
 		error("getaddrinfo %s: %s", host, ssh_gai_strerror(gaierr));
 		return -1;
--- openssh-9.4p1/ssh.c
+++ openssh-9.4p1/ssh.c
@@ -270,6 +270,10 @@ AF_UNSPEC : options.address_family;
 	hints.ai_socktype = SOCK_STREAM;
 	if (cname != NULL)
 		hints.ai_flags = AI_CANONNAME;
+#ifdef AI_ADDRCONFIG
+	if (hints.ai_family == AF_UNSPEC)
+		hints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	if ((gaierr = getaddrinfo(name, strport, &hints, &res)) != 0) {
 		if (logerr || (gaierr != EAI_NONAME && gaierr != EAI_NODATA))
 			loglevel = SYSLOG_LEVEL_ERROR;
@@ -346,6 +350,10 @@ hints.ai_family = options.address_family
 	    AF_UNSPEC : options.address_family;
 	hints.ai_socktype = SOCK_STREAM;
 	hints.ai_flags = AI_NUMERICHOST|AI_NUMERICSERV;
+#ifdef AI_ADDRCONFIG
+	if (hints.ai_family == AF_UNSPEC)
+		hints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 	if ((gaierr = getaddrinfo(name, strport, &hints, &res)) != 0) {
 		debug2_f("could not resolve name %.100s as address: %s",
 		    name, ssh_gai_strerror(gaierr));
--- openssh-9.4p1/sshconnect.c
+++ openssh-9.4p1/sshconnect.c
@@ -379,6 +379,10 @@ hints.ai_family = ai->ai_family;
 		hints.ai_socktype = ai->ai_socktype;
 		hints.ai_protocol = ai->ai_protocol;
 		hints.ai_flags = AI_PASSIVE;
+#ifdef AI_ADDRCONFIG
+		if (hints.ai_family == AF_UNSPEC)
+			hints.ai_flags |= AI_ADDRCONFIG;
+#endif /* AI_ADDRCONFIG */
 		if ((r = getaddrinfo(options.bind_address, NULL,
 		    &hints, &res)) != 0) {
 			error("getaddrinfo: %s: %s", options.bind_address,
